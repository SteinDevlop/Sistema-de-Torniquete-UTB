<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Reconocimiento Facial - STUTB</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
    .main-container { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
    .section-card { background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
    .btn-custom { border-radius: 25px; padding: 10px 30px; font-weight: 600; }
    h1 { color: #667eea; font-weight: 700; margin-bottom: 10px; }
    h4 { color: #764ba2; font-weight: 600; margin-bottom: 15px; }
    .camera-container { position: relative; width: 100%; max-width: 640px; margin: 0 auto; }
    video, canvas { width: 100%; border-radius: 10px; border: 3px solid #667eea; }
    .result-success { background: #d4edda; border: 2px solid #28a745; border-radius: 10px; padding: 15px; margin-top: 15px; }
    .result-error { background: #f8d7da; border: 2px solid #dc3545; border-radius: 10px; padding: 15px; margin-top: 15px; }
    .result-info { background: #d1ecf1; border: 2px solid #17a2b8; border-radius: 10px; padding: 15px; margin-top: 15px; }
    #capturedImage { display: none; width: 100%; border-radius: 10px; border: 3px solid #28a745; }
  </style>
</head>
<body>
  <div class="container main-container">
    <h1 class="text-center">üîê Reconocimiento Facial</h1>
    <p class="text-center text-muted mb-4">DeepFace + Facenet512</p>

    <!-- PASO 1: REGISTRO CON C√ÅMARA -->
    <div class="section-card">
      <h4>üìù Paso 1: Registrar Usuario (con C√°mara)</h4>
      
      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <label class="form-label fw-bold">ID Usuario</label>
            <input id="regUserId" class="form-control" type="number" placeholder="Ej: 1001" value="1001">
          </div>
          <div class="mb-3">
            <button id="btnStartCamera" class="btn btn-primary btn-custom w-100">üì∑ Abrir C√°mara</button>
            <button id="btnCapture" class="btn btn-success btn-custom w-100 mt-2" style="display:none;">üì∏ Capturar Foto</button>
            <button id="btnRegister" class="btn btn-warning btn-custom w-100 mt-2" style="display:none;">‚úÖ Registrar Usuario</button>
          </div>
          <div id="regResult"></div>
        </div>
        <div class="col-md-6">
          <div class="camera-container">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas" style="display:none;"></canvas>
            <img id="capturedImage" alt="Foto capturada">
          </div>
        </div>
      </div>
    </div>

    <!-- PASO 2: VERIFICACI√ìN CON C√ÅMARA O ARCHIVO -->
    <div class="section-card">
      <h4>‚úÖ Paso 2: Verificar Acceso</h4>
      
      <div class="mb-3">
        <div class="btn-group w-100" role="group">
          <input type="radio" class="btn-check" name="verifyMode" id="modeCamera" checked>
          <label class="btn btn-outline-primary" for="modeCamera">üì∑ Con C√°mara</label>
          
          <input type="radio" class="btn-check" name="verifyMode" id="modeFile">
          <label class="btn btn-outline-primary" for="modeFile">üìÅ Subir Archivo</label>
        </div>
      </div>
      
      <div class="row">
        <div class="col-md-6">
          <!-- Opci√≥n 1: C√°mara -->
          <div id="cameraVerifyPanel">
            <div class="mb-3">
              <button id="btnStartCameraVerify" class="btn btn-primary btn-custom w-100">üì∑ Abrir C√°mara</button>
              <button id="btnCaptureVerify" class="btn btn-success btn-custom w-100 mt-2" style="display:none;">üì∏ Capturar Foto</button>
              <button id="btnVerify" class="btn btn-danger btn-custom w-100 mt-2" style="display:none;">üîì Verificar Acceso</button>
            </div>
          </div>
          
          <!-- Opci√≥n 2: Archivo -->
          <div id="fileVerifyPanel" style="display:none;">
            <div class="mb-3">
              <label class="form-label fw-bold">Seleccionar Imagen</label>
              <input type="file" id="fileInput" class="form-control" accept="image/*">
              <button id="btnVerifyFile" class="btn btn-danger btn-custom w-100 mt-2">üîì Verificar Acceso</button>
            </div>
          </div>
          
          <div id="verifyResult"></div>
        </div>
        <div class="col-md-6">
          <div class="camera-container">
            <video id="videoVerify" autoplay playsinline></video>
            <canvas id="canvasVerify" style="display:none;"></canvas>
            <img id="capturedImageVerify" style="display:none; width: 100%; border-radius: 10px; border: 3px solid #28a745;">
            <img id="uploadedImageVerify" style="display:none; width: 100%; border-radius: 10px; border: 3px solid #17a2b8;">
          </div>
        </div>
      </div>
    </div>

    <!-- PASO 3: USUARIOS REGISTRADOS -->
    <div class="section-card">
      <h4>üë• Usuarios Registrados</h4>
      <button id="btnRefresh" class="btn btn-secondary btn-sm mb-3">üîÑ Actualizar</button>
      <div id="usersList" style="max-height: 300px; overflow-y: auto;"></div>
    </div>
  </div>

  <script>
    const API_ROOT = 'http://localhost:8000';
    let stream = null;
    let streamVerify = null;
    let capturedImageData = null;
    let capturedImageDataVerify = null;

    // Cambio de modo de verificaci√≥n
    document.getElementById('modeCamera').addEventListener('change', () => {
      document.getElementById('cameraVerifyPanel').style.display = 'block';
      document.getElementById('fileVerifyPanel').style.display = 'none';
      document.getElementById('uploadedImageVerify').style.display = 'none';
      document.getElementById('videoVerify').style.display = 'block';
      document.getElementById('capturedImageVerify').style.display = 'none';
      document.getElementById('verifyResult').innerHTML = '';
    });

    document.getElementById('modeFile').addEventListener('change', () => {
      document.getElementById('cameraVerifyPanel').style.display = 'none';
      document.getElementById('fileVerifyPanel').style.display = 'block';
      document.getElementById('videoVerify').style.display = 'none';
      document.getElementById('capturedImageVerify').style.display = 'none';
      document.getElementById('uploadedImageVerify').style.display = 'none';
      document.getElementById('verifyResult').innerHTML = '';
      
      // Detener c√°mara si est√° activa
      if (streamVerify) {
        streamVerify.getTracks().forEach(track => track.stop());
        streamVerify = null;
      }
    });

    // Previsualizar imagen subida
    document.getElementById('fileInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = document.getElementById('uploadedImageVerify');
          img.src = event.target.result;
          img.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });

    // REGISTRO - Abrir c√°mara
    document.getElementById('btnStartCamera').addEventListener('click', async () => {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
        document.getElementById('video').srcObject = stream;
        document.getElementById('btnStartCamera').style.display = 'none';
        document.getElementById('btnCapture').style.display = 'block';
        document.getElementById('capturedImage').style.display = 'none';
      } catch (e) {
        alert('Error al acceder a la c√°mara: ' + e.message);
      }
    });

    // REGISTRO - Capturar foto
    document.getElementById('btnCapture').addEventListener('click', () => {
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const img = document.getElementById('capturedImage');
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0);
      
      capturedImageData = canvas.toDataURL('image/jpeg', 0.9);
      img.src = capturedImageData;
      img.style.display = 'block';
      video.style.display = 'none';
      
      // Detener c√°mara
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      
      document.getElementById('btnCapture').style.display = 'none';
      document.getElementById('btnRegister').style.display = 'block';
      document.getElementById('btnStartCamera').style.display = 'block';
      document.getElementById('btnStartCamera').textContent = 'üîÑ Tomar otra foto';
    });

    // REGISTRO - Registrar usuario
    document.getElementById('btnRegister').addEventListener('click', async () => {
      const userId = document.getElementById('regUserId').value;
      
      if (!userId) {
        document.getElementById('regResult').innerHTML = '<div class="result-error">‚ö†Ô∏è Ingresa un ID</div>';
        return;
      }
      if (!capturedImageData) {
        document.getElementById('regResult').innerHTML = '<div class="result-error">‚ö†Ô∏è Captura una foto primero</div>';
        return;
      }

      document.getElementById('regResult').innerHTML = '<div class="result-info">‚è≥ Procesando...</div>';

      try {
        const base64Clean = capturedImageData.split(',')[1];
        const form = new FormData();
        form.append('id_usuario', userId);
        form.append('imagen_facial', base64Clean);

        const res = await fetch(`${API_ROOT}/biometria/create`, {
          method: 'POST',
          body: form
        });

        const data = await res.json();
        
        if (res.ok && data.success) {
          document.getElementById('regResult').innerHTML = `
            <div class="result-success">
              <strong>‚úÖ Usuario registrado</strong>
              <p class="mb-0">ID: ${userId}</p>
            </div>
          `;
          await refreshUsers();
        } else {
          document.getElementById('regResult').innerHTML = `
            <div class="result-error">
              <strong>‚ùå Error</strong>
              <p class="mb-0">${data.detail || data.message || 'Error'}</p>
            </div>
          `;
        }
      } catch (e) {
        document.getElementById('regResult').innerHTML = `<div class="result-error">‚ùå ${e.message}</div>`;
      }
    });

    // VERIFICACI√ìN - Abrir c√°mara
    document.getElementById('btnStartCameraVerify').addEventListener('click', async () => {
      try {
        streamVerify = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
        document.getElementById('videoVerify').srcObject = streamVerify;
        document.getElementById('btnStartCameraVerify').style.display = 'none';
        document.getElementById('btnCaptureVerify').style.display = 'block';
        document.getElementById('capturedImageVerify').style.display = 'none';
        document.getElementById('videoVerify').style.display = 'block';
      } catch (e) {
        alert('Error al acceder a la c√°mara: ' + e.message);
      }
    });

    // VERIFICACI√ìN - Capturar foto
    document.getElementById('btnCaptureVerify').addEventListener('click', () => {
      const video = document.getElementById('videoVerify');
      const canvas = document.getElementById('canvasVerify');
      const img = document.getElementById('capturedImageVerify');
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0);
      
      capturedImageDataVerify = canvas.toDataURL('image/jpeg', 0.9);
      img.src = capturedImageDataVerify;
      img.style.display = 'block';
      video.style.display = 'none';
      
      if (streamVerify) {
        streamVerify.getTracks().forEach(track => track.stop());
        streamVerify = null;
      }
      
      document.getElementById('btnCaptureVerify').style.display = 'none';
      document.getElementById('btnVerify').style.display = 'block';
      document.getElementById('btnStartCameraVerify').style.display = 'block';
      document.getElementById('btnStartCameraVerify').textContent = 'üîÑ Tomar otra foto';
    });

    // VERIFICACI√ìN - Verificar acceso con c√°mara
    document.getElementById('btnVerify').addEventListener('click', async () => {
      if (!capturedImageDataVerify) {
        document.getElementById('verifyResult').innerHTML = '<div class="result-error">‚ö†Ô∏è Captura una foto</div>';
        return;
      }

      document.getElementById('verifyResult').innerHTML = '<div class="result-info">‚è≥ Verificando...</div>';

      try {
        const base64Clean = capturedImageDataVerify.split(',')[1];
        const form = new FormData();
        form.append('dispositivo_id', 'web_test');
        form.append('imagen_facial', base64Clean);

        const res = await fetch(`${API_ROOT}/acceso/camara`, {
          method: 'POST',
          body: form
        });

        const data = await res.json();
        
        if (data.status === true) {
          let detallesHtml = '';
          if (data.detalles_verificacion) {
            const d = data.detalles_verificacion;
            detallesHtml = `
              <hr>
              <small>
                <strong>üìä Detalles de Verificaci√≥n:</strong><br>
                ‚Ä¢ Candidatos evaluados: ${d.candidatos_evaluados || 0}<br>
                ‚Ä¢ Score obtenido: ${d.mejor_score ? (d.mejor_score * 100).toFixed(2) : '0.00'}%<br>
                ‚Ä¢ Umbral requerido: ${d.umbral_score ? (d.umbral_score * 100).toFixed(0) : '70'}%<br>
                ‚Ä¢ Distancia: ${d.mejor_distancia ? d.mejor_distancia.toFixed(4) : 'N/A'}
              </small>
            `;
            
            if (d.todos_scores && d.todos_scores.length > 0) {
              detallesHtml += '<br><br><strong>üèÜ Top 5 Coincidencias:</strong><ul class="small mb-0">';
              d.todos_scores.slice(0, 5).forEach((s, i) => {
                detallesHtml += `<li>Usuario ${s.usuario_id}: ${s.porcentaje_similitud}% (${s.score.toFixed(4)})</li>`;
              });
              detallesHtml += '</ul>';
            }
          }
          
          document.getElementById('verifyResult').innerHTML = `
            <div class="result-success">
              <strong>‚úÖ ACCESO CONCEDIDO</strong>
              <p class="mb-0">${data.mensaje}</p>
              <p class="mb-0">Usuario: <strong>${data.usuario_id}</strong></p>
              ${data.score ? `<p class="mb-0">Similitud: ${(data.score * 100).toFixed(1)}%</p>` : ''}
              ${detallesHtml}
            </div>
          `;
        } else {
          let detallesHtml = '';
          if (data.detalles_verificacion) {
            const d = data.detalles_verificacion;
            detallesHtml = `
              <hr>
              <small>
                <strong>üìä Detalles de Verificaci√≥n:</strong><br>
                ‚Ä¢ Candidatos evaluados: ${d.candidatos_evaluados || 0}<br>
                ‚Ä¢ Mejor score: ${d.mejor_score ? (d.mejor_score * 100).toFixed(2) : '0.00'}%<br>
                ‚Ä¢ Umbral requerido: ${d.umbral_score ? (d.umbral_score * 100).toFixed(0) : '70'}%<br>
                ‚Ä¢ Distancia: ${d.mejor_distancia ? d.mejor_distancia.toFixed(4) : 'N/A'}<br>
                <span class="text-danger">‚ö†Ô∏è Score insuficiente para conceder acceso</span>
              </small>
            `;
            
            if (d.todos_scores && d.todos_scores.length > 0) {
              detallesHtml += '<br><br><strong>üèÜ Top 5 Coincidencias:</strong><ul class="small mb-0">';
              d.todos_scores.slice(0, 5).forEach((s, i) => {
                detallesHtml += `<li>Usuario ${s.usuario_id}: ${s.porcentaje_similitud}% (${s.score.toFixed(4)})</li>`;
              });
              detallesHtml += '</ul>';
            }
          }
          
          document.getElementById('verifyResult').innerHTML = `
            <div class="result-error">
              <strong>‚ùå ACCESO DENEGADO</strong>
              <p class="mb-0">${data.mensaje}</p>
              ${detallesHtml}
            </div>
          `;
        }
      } catch (e) {
        document.getElementById('verifyResult').innerHTML = `<div class="result-error">‚ùå ${e.message}</div>`;
      }
    });

    // VERIFICACI√ìN - Verificar acceso con archivo
    document.getElementById('btnVerifyFile').addEventListener('click', async () => {
      const fileInput = document.getElementById('fileInput');
      
      if (!fileInput.files || fileInput.files.length === 0) {
        document.getElementById('verifyResult').innerHTML = '<div class="result-error">‚ö†Ô∏è Selecciona una imagen primero</div>';
        return;
      }

      document.getElementById('verifyResult').innerHTML = '<div class="result-info">‚è≥ Verificando...</div>';

      try {
        const file = fileInput.files[0];
        const reader = new FileReader();
        
        reader.onload = async (e) => {
          const base64Data = e.target.result;
          const base64Clean = base64Data.split(',')[1];
          
          const form = new FormData();
          form.append('dispositivo_id', 'web_test');
          form.append('imagen_facial', base64Clean);

          const res = await fetch(`${API_ROOT}/acceso/camara`, {
            method: 'POST',
            body: form
          });

          const data = await res.json();
          
          if (data.status === true) {
            let detallesHtml = '';
            if (data.detalles_verificacion) {
              const d = data.detalles_verificacion;
              detallesHtml = `
                <hr>
                <small>
                  <strong>üìä Detalles de Verificaci√≥n:</strong><br>
                  ‚Ä¢ Candidatos evaluados: ${d.candidatos_evaluados || 0}<br>
                  ‚Ä¢ Score obtenido: ${d.mejor_score ? (d.mejor_score * 100).toFixed(2) : '0.00'}%<br>
                  ‚Ä¢ Umbral requerido: ${d.umbral_score ? (d.umbral_score * 100).toFixed(0) : '70'}%<br>
                  ‚Ä¢ Distancia: ${d.mejor_distancia ? d.mejor_distancia.toFixed(4) : 'N/A'}
                </small>
              `;
              
              if (d.todos_scores && d.todos_scores.length > 0) {
                detallesHtml += '<br><br><strong>üèÜ Top 5 Coincidencias:</strong><ul class="small mb-0">';
                d.todos_scores.slice(0, 5).forEach((s, i) => {
                  detallesHtml += `<li>Usuario ${s.usuario_id}: ${s.porcentaje_similitud}% (${s.score.toFixed(4)})</li>`;
                });
                detallesHtml += '</ul>';
              }
            }
            
            document.getElementById('verifyResult').innerHTML = `
              <div class="result-success">
                <strong>‚úÖ ACCESO CONCEDIDO</strong>
                <p class="mb-0">${data.mensaje}</p>
                <p class="mb-0">Usuario: <strong>${data.usuario_id}</strong></p>
                ${data.score ? `<p class="mb-0">Similitud: ${(data.score * 100).toFixed(1)}%</p>` : ''}
                ${detallesHtml}
              </div>
            `;
          } else {
            let detallesHtml = '';
            if (data.detalles_verificacion) {
              const d = data.detalles_verificacion;
              detallesHtml = `
                <hr>
                <small>
                  <strong>üìä Detalles de Verificaci√≥n:</strong><br>
                  ‚Ä¢ Candidatos evaluados: ${d.candidatos_evaluados || 0}<br>
                  ‚Ä¢ Mejor score: ${d.mejor_score ? (d.mejor_score * 100).toFixed(2) : '0.00'}%<br>
                  ‚Ä¢ Umbral requerido: ${d.umbral_score ? (d.umbral_score * 100).toFixed(0) : '70'}%<br>
                  ‚Ä¢ Distancia: ${d.mejor_distancia ? d.mejor_distancia.toFixed(4) : 'N/A'}<br>
                  <span class="text-danger">‚ö†Ô∏è Score insuficiente para conceder acceso</span>
                </small>
              `;
              
              if (d.todos_scores && d.todos_scores.length > 0) {
                detallesHtml += '<br><br><strong>üèÜ Top 5 Coincidencias:</strong><ul class="small mb-0">';
                d.todos_scores.slice(0, 5).forEach((s, i) => {
                  detallesHtml += `<li>Usuario ${s.usuario_id}: ${s.porcentaje_similitud}% (${s.score.toFixed(4)})</li>`;
                });
                detallesHtml += '</ul>';
              }
            }
            
            document.getElementById('verifyResult').innerHTML = `
              <div class="result-error">
                <strong>‚ùå ACCESO DENEGADO</strong>
                <p class="mb-0">${data.mensaje}</p>
                ${detallesHtml}
              </div>
            `;
          }
        };
        
        reader.readAsDataURL(file);
      } catch (e) {
        document.getElementById('verifyResult').innerHTML = `<div class="result-error">‚ùå ${e.message}</div>`;
      }
    });

    // Lista de usuarios
    document.getElementById('btnRefresh').addEventListener('click', refreshUsers);

    async function refreshUsers() {
      const list = document.getElementById('usersList');
      list.innerHTML = '<p class="text-muted">Cargando...</p>';
      
      try {
        const res = await fetch(`${API_ROOT}/biometria/all`);
        const items = await res.json();
        
        if (!items || items.length === 0) {
          list.innerHTML = '<p class="text-muted">No hay usuarios</p>';
          return;
        }

        let html = '<div class="list-group">';
        items.forEach(it => {
          html += `
            <div class="list-group-item">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-1">Usuario ${it.id_usuario}</h6>
                  <small class="text-muted">ID: ${it.id_biometria} | Hash: ${it.facial_hash || 'N/A'}</small>
                </div>
                <button class="btn btn-danger btn-sm" onclick="deleteUser(${it.id_biometria})">üóëÔ∏è</button>
              </div>
            </div>
          `;
        });
        html += '</div>';
        list.innerHTML = html;
      } catch (e) {
        list.innerHTML = `<p class="text-danger">Error: ${e.message}</p>`;
      }
    }

    async function deleteUser(bioId) {
      if (!confirm('¬øEliminar?')) return;
      
      try {
        const form = new FormData();
        form.append('id_biometria', bioId);
        
        const res = await fetch(`${API_ROOT}/biometria/delete`, {
          method: 'POST',
          body: form
        });
        
        const data = await res.json();
        if (data.success) {
          await refreshUsers();
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    refreshUsers();
  </script>
</body>
</html>
